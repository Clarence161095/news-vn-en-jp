{% extends "base.html" %}

{% block title %}Trang Ch·ªß - ƒê·ªçc B√°o Song Ng·ªØ{% endblock %}

{% block extra_css %}
<style>
    /* Search & Filter Section */
    .search-filter-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
    
    body.dark-mode .search-filter-container {
        background: #2c2c2c;
        border: 1px solid #444;
    }
    
    .search-box {
        display: flex;
        gap: 10px;
        align-items: stretch;
        margin-bottom: 15px;
    }
    
    .search-input-wrapper {
        flex: 1;
        position: relative;
    }
    
    #searchInput {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
    }
    
    #searchInput:focus {
        outline: none;
        border-color: #3498db;
    }
    
    body.dark-mode #searchInput {
        background: #3c3c3c;
        border-color: #555;
        color: #e0e0e0;
    }
    
    .search-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        transition: all 0.3s;
        white-space: nowrap;
    }
    
    .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }
    
    .filter-options {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }
    
    body.dark-mode .filter-options {
        border-top-color: #444;
    }
    
    .filter-checkbox {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
    }
    
    .filter-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    /* Category Tags */
    .category-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
    }
    
    .category-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .category-tag:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
    }
    
    .category-tag .remove {
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
    }
    
    .category-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #3498db;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    body.dark-mode .category-suggestions {
        background: #3c3c3c;
        border-color: #3498db;
    }
    
    .category-suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .category-suggestion-item:hover {
        background: #f0f7fb;
    }
    
    body.dark-mode .category-suggestion-item:hover {
        background: #4a4a4a;
    }
    
    /* Article Card Enhancements */
    .article-card {
        position: relative;
        margin-bottom: 20px;
    }
    
    .favorite-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        transition: transform 0.2s;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    .favorite-btn:hover {
        transform: scale(1.2);
    }
    
    .favorite-btn.is-favorite {
        animation: heartBeat 0.5s;
    }
    
    @keyframes heartBeat {
        0%, 100% { transform: scale(1); }
        25% { transform: scale(1.3); }
        50% { transform: scale(1.1); }
        75% { transform: scale(1.25); }
    }
    
    .article-categories {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
    }
    
    .article-category-badge {
        display: inline-block;
        padding: 4px 10px;
        background: #ecf0f1;
        color: #2c3e50;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    body.dark-mode .article-category-badge {
        background: #4a4a4a;
        color: #e0e0e0;
    }
    
    .no-results {
        text-align: center;
        padding: 60px 20px;
        color: #888;
    }
    
    .no-results h3 {
        color: #888;
        margin-bottom: 10px;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .search-box {
            flex-direction: column;
        }
        
        .filter-options {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}


{% block content %}
<!-- Search & Filter Section -->
<div class="search-filter-container">
    <form id="searchForm" method="GET" action="{{ url_for('index') }}">
        <!-- Row 1: Keyword Search -->
        <div style="margin-bottom: 15px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 8px;">
                üîç T√¨m ki·∫øm theo t·ª´ kh√≥a (ti√™u ƒë·ªÅ ho·∫∑c n·ªôi dung)
            </label>
            <div class="search-box">
                <div class="search-input-wrapper" style="flex: 1;">
                    <input type="text" 
                           id="searchInput" 
                           name="q" 
                           placeholder="Nh·∫≠p t·ª´ kh√≥a c·∫ßn t√¨m..."
                           value="{{ search_query }}"
                           autocomplete="off"
                           style="width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                </div>
                
                <button type="submit" class="search-btn" style="white-space: nowrap;">
                    üîç T√¨m ki·∫øm
                </button>
            </div>
            
            <div style="margin-top: 8px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <label class="filter-checkbox">
                    <input type="checkbox" name="regex" value="true" {% if use_regex %}checked{% endif %}>
                    <span style="font-size: 13px;">üîß S·ª≠ d·ª•ng Regex</span>
                </label>
                
                <label class="filter-checkbox">
                    <input type="checkbox" name="favorites" value="true" {% if favorites_only %}checked{% endif %}>
                    <span style="font-size: 13px;">‚ù§Ô∏è Ch·ªâ xem y√™u th√≠ch</span>
                </label>
                
                <label class="filter-checkbox" id="myArticlesCheckbox" style="display: none;">
                    <input type="checkbox" name="my_articles" id="myArticlesInput" value="true">
                    <span style="font-size: 13px;">üë§ <strong>B√†i vi·∫øt c·ªßa t√¥i</strong></span>
                </label>
            </div>
        </div>
        
        <!-- Row 2: Category Filter -->
        <div style="border-top: 1px solid #eee; padding-top: 15px;">
            <label style="display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 8px;">
                üìÅ L·ªçc theo categories
            </label>
            
            <!-- Selected Categories Display -->
            <div id="selectedCategories" class="category-tags" style="min-height: 32px; margin-bottom: 10px;"></div>
            
            <!-- Category Dropdown Trigger -->
            <div style="position: relative;">
                <button type="button" 
                        id="categoryDropdownBtn"
                        onclick="toggleCategoryDropdown()"
                        style="padding: 10px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                    <span>üìÅ Ch·ªçn categories...</span>
                    <span id="dropdownIcon">‚ñº</span>
                </button>
                
                <!-- Category Dropdown Menu -->
                <div id="categoryDropdown" 
                     style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-radius: 8px; margin-top: 5px; max-height: 350px; overflow: hidden; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    
                    <!-- Header with Filter & Refresh -->
                    <div style="padding: 10px; border-bottom: 2px solid #eee; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <!-- Filter Input -->
                            <input type="text" 
                                   id="categoryFilterInput" 
                                   placeholder="üîç G√µ ƒë·ªÉ l·ªçc categories..."
                                   oninput="filterCategoryList()"
                                   style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
                            
                            <!-- Refresh Button -->
                            <button type="button"
                                    onclick="cleanupUnusedCategories()"
                                    title="X√≥a categories kh√¥ng c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng"
                                    style="padding: 8px 12px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: transform 0.2s;"
                                    onmouseover="this.style.transform='rotate(180deg)'"
                                    onmouseout="this.style.transform='rotate(0deg)'">
                                üîÑ
                            </button>
                        </div>
                        <p style="margin: 0; font-size: 11px; color: #666;">
                            üí° G√µ ƒë·ªÉ t√¨m nhanh ‚Ä¢ Click üîÑ ƒë·ªÉ d·ªçn d·∫πp
                        </p>
                    </div>
                    
                    <!-- Category List -->
                    <div id="categoryList" style="padding: 5px; max-height: 200px; overflow-y: auto;"></div>
                    
                    <!-- Footer -->
                    <div style="padding: 10px; border-top: 1px solid #eee; background: #f8f9fa;">
                        <p style="margin: 0; font-size: 12px; color: #888; text-align: center;">
                            <span id="categoryCountInfo">0</span> categories
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden inputs for selected categories (multiple) -->
        <div id="hiddenCategoryInputs"></div>
    </form>
</div>

<h2 style="margin-bottom: 20px; color: #2c3e50;">
    {% if search_query or selected_categories or favorites_only %}
        K·∫øt qu·∫£ t√¨m ki·∫øm ({{ articles|length }} b√†i)
    {% else %}
        Danh S√°ch B√†i Vi·∫øt ({{ articles|length }})
    {% endif %}
</h2>

{% if articles %}
    {% for article in articles %}
    <div class="card article-card">
        <!-- Favorite Button -->
        <button class="favorite-btn {% if article['is_favorite'] %}is-favorite{% endif %}" 
                onclick="toggleFavorite({{ article['id'] }}, this)"
                title="{% if article['is_favorite'] %}B·ªè y√™u th√≠ch{% else %}Th√™m v√†o y√™u th√≠ch{% endif %}">
            {% if article['is_favorite'] %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
        </button>
        
        <a href="{{ url_for('article_detail', article_id=article['id'], lang='both') }}" 
           style="text-decoration: none; color: inherit;">
            <h3 style="color: #2c3e50; margin-bottom: 5px; padding-right: 50px; cursor: pointer; transition: color 0.2s;"
                onmouseover="this.style.color='#3498db'" onmouseout="this.style.color='#2c3e50'">
                {{ article['title_vi'] or article['title_en'] }}
            </h3>
        </a>
        
        {% if article['title_en'] and article['title_vi'] %}
        <p style="color: #7f8c8d; font-size: 0.95em; margin-bottom: 15px; font-style: italic;">
            {{ article['title_en'] }}
        </p>
        {% endif %}
        
        <p style="color: #888; font-size: 0.9em; margin-bottom: 10px;">
            üìÖ {{ article['created_at'] }}
        </p>
        
        <!-- Article Categories -->
        <div class="article-categories" id="categories-{{ article['id'] }}">
            <!-- Will be loaded via JavaScript -->
        </div>
        
        <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
            <a href="{{ url_for('article_detail', article_id=article['id'], lang='vi') }}" 
               style="display: inline-block; padding: 10px 16px; background-color: #3498db; color: white; text-decoration: none; border-radius: 5px; font-size: 0.95em; font-weight: 500;">
                üáªüá≥ Vi·ªát
            </a>
            <a href="{{ url_for('article_detail', article_id=article['id'], lang='en') }}" 
               style="display: inline-block; padding: 10px 16px; background-color: #2ecc71; color: white; text-decoration: none; border-radius: 5px; font-size: 0.95em; font-weight: 500;">
                üá¨üáß Anh
            </a>
            <a href="{{ url_for('article_detail', article_id=article['id'], lang='both') }}" 
               style="display: inline-block; padding: 10px 16px; background-color: #e67e22; color: white; text-decoration: none; border-radius: 5px; font-size: 0.95em; font-weight: 500;">
                üåç Song Ng·ªØ
            </a>
            
            <!-- Delete Button - Only show if user owns this article -->
            <button type="button" 
                    class="delete-article-btn"
                    data-article-id="{{ article['id'] }}"
                    onclick="deleteArticleFromHomepage({{ article['id'] }})"
                    style="display: none; padding: 10px 16px; background-color: #c0392b; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95em; font-weight: 500; margin-left: auto;">
                üóëÔ∏è X√≥a
            </button>
        </div>
    </div>
    {% endfor %}
    
    <!-- PAGINATION -->
    {% if total_pages > 1 %}
    <div class="pagination-container" style="margin-top: 30px; text-align: center;">
        <div style="background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: inline-block;">
            <div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">
                üìÑ Trang {{ page }}/{{ total_pages }} (T·ªïng {{ total_count }} b√†i vi·∫øt)
            </div>
            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                {% if page > 1 %}
                <a href="?page=1{{ '&q=' + search_query if search_query else '' }}{{ '&regex=true' if use_regex else '' }}{% for cat in selected_categories %}&categories={{ cat }}{% endfor %}{{ '&favorites=true' if favorites_only else '' }}"
                   class="pagination-btn" style="padding: 8px 12px; background: #3498db; color: white; border-radius: 5px; text-decoration: none; font-weight: 500; transition: background 0.2s;"
                   onmouseover="this.style.background='#2980b9'" onmouseout="this.style.background='#3498db'">
                    ‚èÆÔ∏è ƒê·∫ßu
                </a>
                <a href="?page={{ page - 1 }}{{ '&q=' + search_query if search_query else '' }}{{ '&regex=true' if use_regex else '' }}{% for cat in selected_categories %}&categories={{ cat }}{% endfor %}{{ '&favorites=true' if favorites_only else '' }}"
                   class="pagination-btn" style="padding: 8px 12px; background: #3498db; color: white; border-radius: 5px; text-decoration: none; font-weight: 500; transition: background 0.2s;"
                   onmouseover="this.style.background='#2980b9'" onmouseout="this.style.background='#3498db'">
                    ‚¨ÖÔ∏è Tr∆∞·ªõc
                </a>
                {% endif %}
                
                <!-- Page numbers -->
                {% set start_page = [1, page - 2]|max %}
                {% set end_page = [total_pages, page + 2]|min %}
                
                {% for p in range(start_page, end_page + 1) %}
                <a href="?page={{ p }}{{ '&q=' + search_query if search_query else '' }}{{ '&regex=true' if use_regex else '' }}{% for cat in selected_categories %}&categories={{ cat }}{% endfor %}{{ '&favorites=true' if favorites_only else '' }}"
                   class="pagination-btn {% if p == page %}pagination-active{% endif %}"
                   style="padding: 8px 12px; {% if p == page %}background: #e67e22; font-weight: bold;{% else %}background: #95a5a6;{% endif %} color: white; border-radius: 5px; text-decoration: none; transition: background 0.2s;"
                   onmouseover="if ({{ p }} != {{ page }}) this.style.background='#7f8c8d'"
                   onmouseout="if ({{ p }} != {{ page }}) this.style.background='#95a5a6'">
                    {{ p }}
                </a>
                {% endfor %}
                
                {% if page < total_pages %}
                <a href="?page={{ page + 1 }}{{ '&q=' + search_query if search_query else '' }}{{ '&regex=true' if use_regex else '' }}{% for cat in selected_categories %}&categories={{ cat }}{% endfor %}{{ '&favorites=true' if favorites_only else '' }}"
                   class="pagination-btn" style="padding: 8px 12px; background: #3498db; color: white; border-radius: 5px; text-decoration: none; font-weight: 500; transition: background 0.2s;"
                   onmouseover="this.style.background='#2980b9'" onmouseout="this.style.background='#3498db'">
                    Ti·∫øp ‚û°Ô∏è
                </a>
                <a href="?page={{ total_pages }}{{ '&q=' + search_query if search_query else '' }}{{ '&regex=true' if use_regex else '' }}{% for cat in selected_categories %}&categories={{ cat }}{% endfor %}{{ '&favorites=true' if favorites_only else '' }}"
                   class="pagination-btn" style="padding: 8px 12px; background: #3498db; color: white; border-radius: 5px; text-decoration: none; font-weight: 500; transition: background 0.2s;"
                   onmouseover="this.style.background='#2980b9'" onmouseout="this.style.background='#3498db'">
                    Cu·ªëi ‚è≠Ô∏è
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    <!-- END PAGINATION -->
    
{% else %}
    <div class="card no-results">
        {% if search_query or selected_categories or favorites_only %}
            <h3>üòî Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o</h3>
            <p>Th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a ho·∫∑c b·ªô l·ªçc</p>
            <a href="{{ url_for('index') }}" style="color: #3498db; text-decoration: none; font-weight: bold;">
                ‚Üê Xem t·∫•t c·∫£ b√†i vi·∫øt
            </a>
        {% else %}
            <h3>üìù Ch∆∞a c√≥ b√†i vi·∫øt n√†o</h3>
            <p>H√£y <a href="{{ url_for('import_articles') }}" style="color: #3498db;">import JSON</a> ƒë·ªÉ th√™m n·ªôi dung!</p>
        {% endif %}
    </div>
{% endif %}

<script>
    // Category management
    let selectedCategories = {{ selected_categories|tojson if selected_categories else '[]' }};
    let allCategories = {{ all_categories|tojson if all_categories else '[]' }};
    let dropdownOpen = false;
    
    // Toggle category dropdown
    function toggleCategoryDropdown() {
        dropdownOpen = !dropdownOpen;
        const dropdown = document.getElementById('categoryDropdown');
        const icon = document.getElementById('dropdownIcon');
        
        if (dropdownOpen) {
            dropdown.style.display = 'block';
            icon.textContent = '‚ñ≤';
            displayCategoryList();
        } else {
            dropdown.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    }
    
    // Display all categories as checkboxes (with optional filter)
    function displayCategoryList(filterQuery = '') {
        const container = document.getElementById('categoryList');
        const countInfo = document.getElementById('categoryCountInfo');
        if (!container) return;
        
        if (allCategories.length === 0) {
            container.innerHTML = '<p style="padding: 15px; text-align: center; color: #888; font-size: 13px;">Ch∆∞a c√≥ category n√†o. T·∫°o category trong b√†i vi·∫øt!</p>';
            if (countInfo) countInfo.textContent = '0';
            return;
        }
        
        // Filter categories based on search query
        const filtered = allCategories.filter(c => 
            c.name.toLowerCase().includes(filterQuery.toLowerCase())
        );
        
        if (filtered.length === 0) {
            container.innerHTML = '<p style="padding: 15px; text-align: center; color: #888; font-size: 13px;">‚ùå Kh√¥ng t√¨m th·∫•y category ph√π h·ª£p</p>';
            if (countInfo) countInfo.textContent = '0';
            return;
        }
        
        container.innerHTML = filtered.map(c => {
            const catName = c.name;
            const isSelected = selectedCategories.includes(catName);
            return `
                <label style="display: flex; align-items: center; padding: 10px 12px; cursor: pointer; transition: background 0.2s; border-radius: 5px; margin: 2px 0;"
                       onmouseover="this.style.background='#f0f7fb'"
                       onmouseout="this.style.background='transparent'">
                    <input type="checkbox" 
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleCategorySelection('${catName.replace(/'/g, "\\'")}')"
                           style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                    <span style="font-size: 14px; color: #2c3e50; font-weight: ${isSelected ? '600' : '400'};">
                        üìÅ ${catName}
                    </span>
                </label>
            `;
        }).join('');
        
        if (countInfo) {
            countInfo.textContent = filtered.length < allCategories.length 
                ? `${filtered.length}/${allCategories.length}` 
                : allCategories.length;
        }
    }
    
    // Filter category list based on search input
    function filterCategoryList() {
        const input = document.getElementById('categoryFilterInput');
        const query = input ? input.value.trim() : '';
        displayCategoryList(query);
    }
    
    // Toggle category selection
    function toggleCategorySelection(categoryName) {
        if (selectedCategories.includes(categoryName)) {
            selectedCategories = selectedCategories.filter(c => c !== categoryName);
        } else {
            selectedCategories.push(categoryName);
        }
        updateCategoryTags();
        displayCategoryList(); // Refresh checkboxes
    }
    
    // Initialize selected categories display
    function updateCategoryTags() {
        const container = document.getElementById('selectedCategories');
        const hiddenContainer = document.getElementById('hiddenCategoryInputs');
        
        container.innerHTML = '';
        hiddenContainer.innerHTML = '';
        
        if (selectedCategories.length === 0) {
            container.innerHTML = '<p style="margin: 0; padding: 8px 12px; color: #999; font-size: 13px; font-style: italic;">Ch∆∞a ch·ªçn category n√†o</p>';
        } else {
            selectedCategories.forEach(cat => {
                const tag = document.createElement('div');
                tag.className = 'category-tag';
                tag.innerHTML = `
                    <span>üìÅ ${cat}</span>
                    <span class="remove" onclick="removeCategory('${cat.replace(/'/g, "\\'")}')">√ó</span>
                `;
                container.appendChild(tag);
                
                // Add hidden input for form submission
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'categories';
                input.value = cat;
                hiddenContainer.appendChild(input);
            });
        }
    }
    
    function removeCategory(categoryName) {
        selectedCategories = selectedCategories.filter(c => c !== categoryName);
        updateCategoryTags();
        if (dropdownOpen) {
            displayCategoryList(); // Refresh checkboxes
        }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('categoryDropdown');
        const btn = document.getElementById('categoryDropdownBtn');
        
        if (dropdownOpen && !dropdown.contains(e.target) && !btn.contains(e.target)) {
            toggleCategoryDropdown();
        }
    });
    
    // Cleanup unused categories
    async function cleanupUnusedCategories() {
        if (!confirm('üßπ X√≥a t·∫•t c·∫£ categories kh√¥ng c√≤n ƒë∆∞·ª£c s·ª≠ d·ª•ng?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/categories/cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show detailed message with stats
                let message = data.message;
                if (data.stats) {
                    message += `\n\nüìä Th·ªëng k√™:\n`;
                    message += `‚Ä¢ Categories tr∆∞·ªõc: ${data.stats.before}\n`;
                    message += `‚Ä¢ Categories sau: ${data.stats.after}\n`;
                    message += `‚Ä¢ T·ªïng li√™n k·∫øt: ${data.stats.total_links}`;
                }
                
                alert(message);
                
                // Reload page to refresh category list
                if (data.deleted_count > 0) {
                    window.location.reload();
                }
            } else {
                alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ x√≥a categories'));
                console.error('Cleanup error:', data);
            }
        } catch (error) {
            console.error('Failed to cleanup categories:', error);
            alert('L·ªói khi x√≥a categories: ' + error.message);
        }
    }
    
    // Initialize on page load
    updateCategoryTags();
    
    // Load article categories
    async function loadArticleCategories(articleId) {
        try {
            const response = await fetch(`/api/article/${articleId}/categories`);
            const data = await response.json();
            
            if (data.success && data.categories.length > 0) {
                const container = document.getElementById(`categories-${articleId}`);
                container.innerHTML = data.categories.map(cat => `
                    <span class="article-category-badge">üìÅ ${cat.name}</span>
                `).join('');
            }
        } catch (error) {
            console.error('Failed to load categories:', error);
        }
    }
    
    // Load categories for all articles
    document.addEventListener('DOMContentLoaded', async function() {
        const username = getUsername();
        const urlParams = new URLSearchParams(window.location.search);
        const currentCategories = urlParams.getAll('categories');
        
        // Show "My Articles" checkbox if username is set
        if (username) {
            const checkbox = document.getElementById('myArticlesCheckbox');
            checkbox.style.display = 'flex';
            
            // Update label with username
            const label = checkbox.querySelector('span');
            label.innerHTML = `üë§ <strong>B√†i vi·∫øt c·ªßa ${username}</strong>`;
            
            // Auto-check if currently filtering by username
            if (currentCategories.includes(username)) {
                document.getElementById('myArticlesInput').checked = true;
            }
        }
        
        // Auto-filter by current username if:
        // 1. Username is set
        // 2. No manual category filter applied
        // 3. Not explicitly cleared (no 'noclear' param)
        // 4. "My Articles" checkbox not explicitly unchecked
        if (username && currentCategories.length === 0 && !urlParams.has('noclear')) {
            console.log(`üéØ Auto-filtering by username: ${username}`);
            
            // Redirect with username category filter
            urlParams.append('categories', username);
            window.location.search = urlParams.toString();
            return; // Stop execution, page will reload
        }
        
        // Load categories for all articles
        {% for article in articles %}
        loadArticleCategories({{ article['id'] }});
        {% endfor %}
        
        // Load user favorites and update UI
        if (username) {
            await loadUserFavorites(username);
            
            // Show delete buttons for articles owned by user
            await showDeleteButtonsForUserArticles(username);
        }
    });
    
    // Handle "My Articles" checkbox change
    document.getElementById('myArticlesInput')?.addEventListener('change', function(e) {
        const username = getUsername();
        if (!username) return;
        
        const urlParams = new URLSearchParams(window.location.search);
        const currentCategories = urlParams.getAll('categories');
        
        if (e.target.checked) {
            // Add username to categories if not already there
            if (!currentCategories.includes(username)) {
                urlParams.append('categories', username);
            }
        } else {
            // Remove username from categories
            urlParams.delete('categories');
            currentCategories.filter(c => c !== username).forEach(cat => {
                urlParams.append('categories', cat);
            });
            
            // Add noclear to prevent auto-filter
            urlParams.set('noclear', '1');
        }
        
        // Submit form to apply filter
        window.location.search = urlParams.toString();
    });
    
    // Load user favorites and update heart icons
    async function loadUserFavorites(username) {
        try {
            const response = await fetch(`/api/user/${encodeURIComponent(username)}/favorites`);
            const data = await response.json();
            
            if (data.success) {
                // Update all favorite buttons
                data.favorite_ids.forEach(articleId => {
                    const button = document.querySelector(`button[onclick*="toggleFavorite(${articleId}"]`);
                    if (button) {
                        button.textContent = '‚ù§Ô∏è';
                        button.classList.add('is-favorite');
                        button.title = 'B·ªè y√™u th√≠ch';
                    }
                });
                
                console.log(`‚úÖ Loaded ${data.favorite_ids.length} favorites for ${username}`);
            }
        } catch (error) {
            console.error('Failed to load user favorites:', error);
        }
    }
    
    // Show delete buttons for articles owned by current user
    async function showDeleteButtonsForUserArticles(username) {
        try {
            // Get all article cards
            const deleteButtons = document.querySelectorAll('.delete-article-btn');
            
            for (const btn of deleteButtons) {
                const articleId = btn.getAttribute('data-article-id');
                
                // Get article categories
                const response = await fetch(`/api/article/${articleId}/categories`);
                const data = await response.json();
                
                if (data.success) {
                    const categories = data.categories.map(c => c.name);
                    
                    // Show delete button if article has username category
                    if (categories.includes(username)) {
                        btn.style.display = 'inline-block';
                        console.log(`‚úÖ Show delete button for article ${articleId} (owned by ${username})`);
                    }
                }
            }
        } catch (error) {
            console.error('Failed to check article ownership:', error);
        }
    }
    
    // Delete article from homepage
    async function deleteArticleFromHomepage(articleId) {
        const username = getUsername();
        
        if (!username) {
            alert('‚ö†Ô∏è Vui l√≤ng ƒë·∫∑t t√™n ng∆∞·ªùi d√πng tr∆∞·ªõc!');
            return;
        }
        
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?\n\n‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
            return;
        }
        
        try {
            const response = await fetch(`/article/delete/${articleId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: username})
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(data.message || '‚úÖ B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c x√≥a!');
                window.location.reload();
            } else {
                alert(data.error || '‚ùå Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt');
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('‚ùå L·ªói khi x√≥a b√†i vi·∫øt: ' + error.message);
        }
    }
    
    // Toggle favorite with auto-add username category
    async function toggleFavorite(articleId, button) {
        try {
            // Check if username is set
            const username = getUsername();
            if (!username) {
                alert('‚ö†Ô∏è Vui l√≤ng ƒë·∫∑t t√™n ng∆∞·ªùi d√πng tr∆∞·ªõc!\n\nClick v√†o "üë§ Ch∆∞a ƒë·∫∑t t√™n" ·ªü header ƒë·ªÉ ƒë·∫∑t t√™n.');
                return;
            }
            
            const response = await fetch(`/api/article/${articleId}/favorite`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: username})
            });
            
            const data = await response.json();
            
            if (data.success) {
                button.textContent = data.is_favorite ? '‚ù§Ô∏è' : 'ü§ç';
                button.title = data.is_favorite ? 'B·ªè y√™u th√≠ch' : 'Th√™m v√†o y√™u th√≠ch';
                
                if (data.is_favorite) {
                    button.classList.add('is-favorite');
                    
                    // Auto-add username as category (6th category, separate from normal 5 categories)
                    await addUsernameCategoryToArticle(articleId, username);
                } else {
                    button.classList.remove('is-favorite');
                    
                    // Optionally remove username category when unfavorite
                    // await removeUsernameCategoryFromArticle(articleId, username);
                }
                
                // Show notification
                showNotification(data.message);
            }
        } catch (error) {
            console.error('Failed to toggle favorite:', error);
            showNotification('‚ùå L·ªói khi c·∫≠p nh·∫≠t y√™u th√≠ch');
        }
    }
    
    // Add username as special category (6th category)
    async function addUsernameCategoryToArticle(articleId, username) {
        try {
            // Get current categories
            const response = await fetch(`/api/article/${articleId}/categories`);
            const data = await response.json();
            
            if (data.success) {
                const currentCategories = data.categories.map(c => c.name);
                
                // Add username if not already exists
                if (!currentCategories.includes(username)) {
                    currentCategories.push(username);
                    
                    // Update categories
                    await fetch(`/api/article/${articleId}/categories`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({categories: currentCategories})
                    });
                    
                    console.log(`‚úÖ Added username category: ${username}`);
                }
            }
        } catch (error) {
            console.error('Failed to add username category:', error);
        }
    }
    
    // Simple notification
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }
    
    // Add animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
