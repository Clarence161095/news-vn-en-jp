{% extends "base.html" %}

{% block title %}{{ article['title_vi'] or article['title_en'] }} - ƒê·ªçc B√°o{% endblock %}

{% block extra_css %}
<style>
    /* Loading animation */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-indicator {
        text-align: center;
        padding: 10px;
        color: #667eea;
        font-size: 0.9em;
    }
    
    /* Sentence lazy loading */
    .sentence-loading {
        background-color: rgba(102, 126, 234, 0.1);
        padding: 2px 4px;
        border-radius: 3px;
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }
    
    .article-content {
        padding-top: 1em;
        line-height: 2.5;
    }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="{{ url_for('index') }}" style="color: #3498db; text-decoration: none;">‚Üê Quay l·∫°i danh s√°ch</a>
</div>

<div class="card">
    <h2 style="color: #2c3e50; margin-bottom: 20px;">
        {{ article['title_vi'] or article['title_en'] or article['title_jp'] }}
    </h2>
    
    <!-- Language Selector -->
    <div class="lang-selector">
        <button class="lang-btn {% if lang == 'vi' %}active{% endif %}" onclick="switchLang('vi')">
            üáªüá≥ Ti·∫øng Vi·ªát
        </button>
        <button class="lang-btn {% if lang == 'jp' %}active{% endif %}" onclick="switchLang('jp')">
            üáØüáµ Êó•Êú¨Ë™û (Furigana)
        </button>
    </div>
    
    <!-- Vietnamese Content -->
    <div id="content-vi" class="content-section {% if lang == 'vi' %}active{% endif %}">
        <div class="article-content">
            <h3>{{ article['title_vi'] }}</h3>
            <div>{{ article['content_vi']|safe }}</div>
        </div>
    </div>
    
    <!-- Japanese Content with Lazy Loading Furigana -->
    <div id="content-jp" class="content-section {% if lang == 'jp' %}active{% endif %}">
        <div class="article-content">
            <h3 id="jp-title" data-original="{{ article['title_jp'] }}">
                {{ article['title_jp'] }}
            </h3>
            <div id="jp-content" data-original="{{ article['content_jp'] }}">
                {{ article['content_jp']|safe }}
            </div>
            <div id="furigana-progress" class="loading-indicator" style="display: none;">
                <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #667eea; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span style="margin-left: 10px;">ƒêang t·∫°o Furigana: <span id="progress-text">0%</span></span>
            </div>
        </div>
    </div>
</div>

<script>
    let isGenerating = false;
    
    function switchLang(lang) {
        const url = new URL(window.location);
        url.searchParams.set('lang', lang);
        window.history.pushState({}, '', url);
        
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        document.getElementById('content-' + lang).classList.add('active');
        
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Trigger lazy loading khi chuy·ªÉn sang tab ti·∫øng Nh·∫≠t
        if (lang === 'jp') {
            lazyLoadFurigana();
        }
    }
    
    // Lazy loading furigana t·ª´ng c√¢u
    async function lazyLoadFurigana() {
        if (isGenerating) return;
        
        const titleEl = document.getElementById('jp-title');
        const contentEl = document.getElementById('jp-content');
        const progressEl = document.getElementById('furigana-progress');
        const progressText = document.getElementById('progress-text');
        
        // Ki·ªÉm tra xem ƒë√£ generate ch∆∞a
        if (titleEl.innerHTML.includes('<ruby>')) {
            return;
        }
        
        isGenerating = true;
        progressEl.style.display = 'block';
        
        try {
            // 1. Generate title tr∆∞·ªõc (nhanh)
            const titleOriginal = titleEl.getAttribute('data-original');
            if (titleOriginal) {
                const titleResult = await generateChunk(titleOriginal, 'furigana');
                if (titleResult.success) {
                    titleEl.innerHTML = titleResult.processed;
                }
            }
            
            // 2. T√°ch content th√†nh c√°c c√¢u
            const contentOriginal = contentEl.getAttribute('data-original');
            if (!contentOriginal) {
                isGenerating = false;
                progressEl.style.display = 'none';
                return;
            }
            
            // T√°ch content th√†nh sentences
            const sentences = splitIntoSentences(contentOriginal);
            const totalSentences = sentences.length;
            let processedCount = 0;
            
            // Clear content v√† b·∫Øt ƒë·∫ßu lazy load
            contentEl.innerHTML = '';
            
            // Process t·ª´ng c√¢u m·ªôt
            for (let i = 0; i < sentences.length; i++) {
                const sentence = sentences[i];
                
                // Th√™m c√¢u g·ªëc v√†o DOM tr∆∞·ªõc (ƒë·ªÉ user ƒë·ªçc ƒë∆∞·ª£c ngay)
                const sentenceSpan = document.createElement('span');
                sentenceSpan.className = 'sentence-loading';
                sentenceSpan.innerHTML = sentence;
                contentEl.appendChild(sentenceSpan);
                
                // Generate furigana cho c√¢u n√†y (async)
                generateChunk(sentence, 'furigana').then(result => {
                    if (result.success) {
                        sentenceSpan.innerHTML = result.processed;
                        sentenceSpan.classList.remove('sentence-loading');
                    }
                    
                    processedCount++;
                    const percent = Math.round((processedCount / totalSentences) * 100);
                    progressText.textContent = `${percent}%`;
                    
                    if (processedCount === totalSentences) {
                        isGenerating = false;
                        progressEl.style.display = 'none';
                    }
                });
                
                // Delay nh·ªè gi·ªØa c√°c request ƒë·ªÉ tr√°nh qu√° t·∫£i
                if (i < sentences.length - 1) {
                    await sleep(50);
                }
            }
            
        } catch (error) {
            console.error('Error during lazy loading:', error);
            isGenerating = false;
            progressEl.style.display = 'none';
        }
    }
    
    async function generateChunk(text, type) {
        try {
            const response = await fetch('/api/furigana/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    type: type
                })
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            return await response.json();
        } catch (error) {
            console.error('Error generating chunk:', error);
            return {
                success: false,
                processed: text
            };
        }
    }
    
    function splitIntoSentences(text) {
        // T√°ch theo d·∫•u c√¢u ti·∫øng Nh·∫≠t
        const sentences = text.split(/([„ÄÇÔºÅÔºü]+)/);
        const result = [];
        
        for (let i = 0; i < sentences.length; i += 2) {
            const sentence = sentences[i];
            const punct = sentences[i + 1] || '';
            if (sentence.trim()) {
                result.push(sentence + punct);
            }
        }
        
        return result.filter(s => s.trim());
    }
    
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // Auto-trigger lazy loading khi trang load v·ªõi lang=jp
    document.addEventListener('DOMContentLoaded', function() {
        const currentLang = new URLSearchParams(window.location.search).get('lang') || 'vi';
        
        if (currentLang === 'jp') {
            lazyLoadFurigana();
        }
    });
</script>
{% endblock %}
